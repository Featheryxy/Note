# Database Connection Pool

重用数据库连接最主要的原因是可以减少应用程序与数据库之间**创建或销毁TCP连接的开销**，数据库连接池。

经典的JDBC连接数据库的步骤大致是这样的：

**加载JDBC驱动→创建数据库连接→创建preparedStatement→执行SQL语句→遍历结果集→关闭资源**

i.e.:应用程序用DataSource数据库驱动来创建一个数据库连接，再通过TCP进行数据库的读写，最后关闭数据库连接。

以访问MySQL为例，执行一个SQL语句的完整TCP流程共经历TCP 3次握手建立连接、MySQL 3次握手认证、SQL语句执行、MySQL关闭、TCP 4次挥手关闭连接这5个步骤

缺点：

1. 创建连接和关闭连接的过程比较耗时，并发时系统会变得很卡顿。
2. 数据库同时支持的连接总数是有限的，如果并发量很大，那么数据库连接的总数就会被消耗光，增加数据库的负载，新的数据库连接请求就会失败。这样就会极大地浪费数据库的资源，极易造成数据库服务器内存溢出、宕机。
3. 为了执行一条SQL，却产生了很多我们并不关心的网络IO。
4. 应用如果频繁地创建连接和关闭连接，会导致JVM临时对象较多，GC频繁。
5. 频繁关闭连接后，会出现大量TIME_WAIT 的TCP状态（在2个MSL之后关闭），这点很棘手。这个问题在第1章中已经结合实践调优经验详细说明过。
6. 应用的响应时间及QPS较低。

使用数据库连接池之后，最直接的改变就是除了第1次访问时需要建立连接以外，之后的访问基本上只需复用已有的连接，而不是重新建立一个

数据库连接池的原理：在系统初始化的时候，在**内存中开辟一片空间**，将一定数量的数据库连接作为对象存储在对象池里，并对外提供数据库连接的获取和归还方法。用户访问数据库时，并不是建立一个新的连接，而是从数据库连接池中取出一个已有的空闲连接对象；使用完毕归还后的连接也不会马上关闭，而是由数据库连接池统一管理回收，为下一次借用做好准备。如果由于高并发请求导致数据库连接池中的连接被借用完毕，其他线程就会等待，直到有连接被归还。整个过程中，连接并不会关闭，而是源源不断地循环使用，有借有还。数据库连接池还可以通过设置其参数来控制连接池中的初始连接数、连接的上下限数，以及每个连接的最大使用次数、最大空闲时间等，也可以通过其自身的管理机制来监视数据库连接的数量、使用情况等